name: Update Azure ARM Organization Secrets (GitHub App)

on:
    workflow_dispatch:
        inputs:
            owner:
                description: "Select ARM owner"
                required: true
                type: choice
                options:
                    - Nilay
                    - Megha

jobs:
    update-org-secrets:
        runs-on: ubuntu-latest

        steps:
            # --------------------------------------------------
            # Step 1: Select ARM values
            # --------------------------------------------------
            - name: Select ARM values
              run: |
                  if [ "${{ github.event.inputs.owner }}" = "Nilay" ]; then
                    echo "ARM_CLIENT_ID=52e8ff65-6ad9-4782-a596-6b9a0f6b69c9" >> $GITHUB_ENV
                    echo "ARM_SUBSCRIPTION_ID=5d24ed5a-049c-4f8d-914f-cdd61e0e7902" >> $GITHUB_ENV
                    echo "ARM_TENANT_ID=e3d35b45-838e-443a-8878-93956a2b5fef" >> $GITHUB_ENV
                  else
                    echo "ARM_CLIENT_ID=e5ccdfb2-a518-4b3a-a7b3-87e1616778e9" >> $GITHUB_ENV
                    echo "ARM_SUBSCRIPTION_ID=99a2d563-027d-4106-9794-b39cdcc42ba6" >> $GITHUB_ENV
                    echo "ARM_TENANT_ID=4486061c-1f73-4472-9fe9-acd0e18d0b7a" >> $GITHUB_ENV
                  fi

            # --------------------------------------------------
            # Step 2: Generate GitHub App JWT
            # --------------------------------------------------
            - name: Generate GitHub App JWT
              run: |
                  sudo apt-get update -y
                  sudo apt-get install -y jq openssl

                  HEADER='{"alg":"RS256","typ":"JWT"}'
                  NOW=$(date +%s)
                  PAYLOAD=$(jq -nc \
                    --arg iat "$NOW" \
                    --arg exp "$((NOW + 540))" \
                    --arg iss "${{ secrets.GH_APP_ID }}" \
                    '{iat:($iat|tonumber),exp:($exp|tonumber),iss:($iss|tonumber)}')

                  b64enc() { openssl base64 -A | tr '+/' '-_' | tr -d '='; }

                  JWT_HEADER=$(echo -n "$HEADER" | b64enc)
                  JWT_PAYLOAD=$(echo -n "$PAYLOAD" | b64enc)

                  SIGNATURE=$(echo -n "$JWT_HEADER.$JWT_PAYLOAD" \
                    | openssl dgst -sha256 -sign <(echo "${{ secrets.GH_APP_PRIVATE_KEY }}") \
                    | b64enc)

                  echo "JWT=$JWT_HEADER.$JWT_PAYLOAD.$SIGNATURE" >> $GITHUB_ENV

            # --------------------------------------------------
            # Step 3: Get Installation Token
            # --------------------------------------------------
            - name: Get GitHub App Installation Token
              run: |
                  TOKEN=$(curl -s -X POST \
                    -H "Authorization: Bearer $JWT" \
                    -H "Accept: application/vnd.github+json" \
                    https://api.github.com/app/installations/${{ secrets.GH_APP_INSTALLATION_ID }}/access_tokens \
                    | jq -r .token)

                  echo "GH_TOKEN=$TOKEN" >> $GITHUB_ENV

            # --------------------------------------------------
            # Step 4: Get Organization Public Key
            # --------------------------------------------------
            - name: Get Organization Public Key
              run: |
                  curl -s \
                    -H "Authorization: Bearer $GH_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    https://api.github.com/orgs/${{ github.repository_owner }}/actions/secrets/public-key \
                    > key.json

                  echo "KEY_ID=$(jq -r .key_id key.json)" >> $GITHUB_ENV
                  echo "PUBLIC_KEY=$(jq -r .key key.json)" >> $GITHUB_ENV

            # --------------------------------------------------
            # Step 5: Encrypt secrets (libsodium – GitHub standard)
            # --------------------------------------------------
            - name: Encrypt secrets using libsodium
              uses: actions/github-script@v7
              with:
                  script: |
                      const sodium = require('libsodium-wrappers');
                      await sodium.ready;

                      function encrypt(secret, publicKey) {
                        const key = sodium.from_base64(
                          publicKey,
                          sodium.base64_variants.ORIGINAL
                        );
                        const encrypted = sodium.crypto_box_seal(
                          sodium.from_string(secret),
                          key
                        );
                        return sodium.to_base64(
                          encrypted,
                          sodium.base64_variants.ORIGINAL
                        );
                      }

                      core.exportVariable(
                        'ENC_CLIENT_ID',
                        encrypt(process.env.ARM_CLIENT_ID, process.env.PUBLIC_KEY)
                      );
                      core.exportVariable(
                        'ENC_SUBSCRIPTION_ID',
                        encrypt(process.env.ARM_SUBSCRIPTION_ID, process.env.PUBLIC_KEY)
                      );
                      core.exportVariable(
                        'ENC_TENANT_ID',
                        encrypt(process.env.ARM_TENANT_ID, process.env.PUBLIC_KEY)
                      );

            # --------------------------------------------------
            # Step 6: Update Organization Secrets
            # --------------------------------------------------
            - name: Update Organization Secrets
              run: |
                  update_secret () {
                    curl -s -X PUT \
                      -H "Authorization: Bearer $GH_TOKEN" \
                      -H "Accept: application/vnd.github+json" \
                      https://api.github.com/orgs/${{ github.repository_owner }}/actions/secrets/$1 \
                      -d "{
                        \"encrypted_value\": \"$2\",
                        \"key_id\": \"$KEY_ID\",
                        \"visibility\": \"all\"
                      }"
                  }

                  update_secret ARM_CLIENT_ID "$ENC_CLIENT_ID"
                  update_secret ARM_SUBSCRIPTION_ID "$ENC_SUBSCRIPTION_ID"
                  update_secret ARM_TENANT_ID "$ENC_TENANT_ID"

            - name: Done
              run: echo "✅ Organization secrets updated securely using GitHub App"
