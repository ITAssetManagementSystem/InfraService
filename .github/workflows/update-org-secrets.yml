name: Update Azure ARM Organization Secrets (GitHub App)

on:
    workflow_dispatch:
        inputs:
            owner:
                description: "Select ARM owner"
                required: true
                type: choice
                options:
                    - Nilay
                    - Megha

jobs:
    update-org-secrets:
        runs-on: ubuntu-latest

        steps:
            # -----------------------------
            # Step 1: Select values
            # -----------------------------
            - name: Select ARM values
              run: |
                  if [ "${{ github.event.inputs.owner }}" = "Nilay" ]; then
                    echo "ARM_CLIENT_ID=52e8ff65-6ad9-4782-a596-6b9a0f6b69c9" >> $GITHUB_ENV
                    echo "ARM_SUBSCRIPTION_ID=5d24ed5a-049c-4f8d-914f-cdd61e0e7902" >> $GITHUB_ENV
                    echo "ARM_TENANT_ID=e3d35b45-838e-443a-8878-93956a2b5fef" >> $GITHUB_ENV
                  else
                    echo "ARM_CLIENT_ID=e5ccdfb2-a518-4b3a-a7b3-87e1616778e9" >> $GITHUB_ENV
                    echo "ARM_SUBSCRIPTION_ID=99a2d563-027d-4106-9794-b39cdcc42ba6" >> $GITHUB_ENV
                    echo "ARM_TENANT_ID=4486061c-1f73-4472-9fe9-acd0e18d0b7a" >> $GITHUB_ENV
                  fi

            # -----------------------------
            # Step 2: Generate JWT for App
            # -----------------------------
            - name: Generate GitHub App JWT
              id: jwt
              run: |
                  sudo apt-get install -y jq openssl

                  HEADER='{"alg":"RS256","typ":"JWT"}'
                  NOW=$(date +%s)
                  PAYLOAD=$(jq -nc \
                    --arg iat "$NOW" \
                    --arg exp "$((NOW + 540))" \
                    --arg iss "${{ secrets.GH_APP_ID }}" \
                    '{iat:($iat|tonumber),exp:($exp|tonumber),iss:($iss|tonumber)}')

                  b64enc() { openssl base64 -A | tr '+/' '-_' | tr -d '='; }

                  JWT_HEADER=$(echo -n "$HEADER" | b64enc)
                  JWT_PAYLOAD=$(echo -n "$PAYLOAD" | b64enc)

                  SIGNATURE=$(echo -n "$JWT_HEADER.$JWT_PAYLOAD" \
                    | openssl dgst -sha256 -sign <(echo "${{ secrets.GH_APP_PRIVATE_KEY }}") \
                    | b64enc)

                  echo "JWT=$JWT_HEADER.$JWT_PAYLOAD.$SIGNATURE" >> $GITHUB_ENV

            # -----------------------------
            # Step 3: Get Installation Token
            # -----------------------------
            - name: Get Installation Token
              run: |
                  TOKEN=$(curl -s -X POST \
                    -H "Authorization: Bearer $JWT" \
                    -H "Accept: application/vnd.github+json" \
                    https://api.github.com/app/installations/${{ secrets.GH_APP_INSTALLATION_ID }}/access_tokens \
                    | jq -r .token)

                  echo "GH_TOKEN=$TOKEN" >> $GITHUB_ENV

            # -----------------------------
            # Step 4: Get Org Public Key
            # -----------------------------
            - name: Get Org Public Key
              run: |
                  curl -s \
                    -H "Authorization: Bearer $GH_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    https://api.github.com/orgs/${{ github.repository_owner }}/actions/secrets/public-key \
                    > key.json

                  echo "KEY_ID=$(jq -r .key_id key.json)" >> $GITHUB_ENV
                  echo "PUBLIC_KEY=$(jq -r .key key.json)" >> $GITHUB_ENV

            # -----------------------------
            # Step 5: Encrypt Secrets
            # -----------------------------
            - name: Encrypt secrets
              run: |
                  encrypt () {
                    echo -n "$1" | \
                    openssl pkeyutl -encrypt \
                      -pubin \
                      -inkey <(echo "$PUBLIC_KEY" | base64 -d) \
                      | base64 | tr -d '\n'
                  }

                  echo "ENC_CLIENT_ID=$(encrypt "$ARM_CLIENT_ID")" >> $GITHUB_ENV
                  echo "ENC_SUBSCRIPTION_ID=$(encrypt "$ARM_SUBSCRIPTION_ID")" >> $GITHUB_ENV
                  echo "ENC_TENANT_ID=$(encrypt "$ARM_TENANT_ID")" >> $GITHUB_ENV

            # -----------------------------
            # Step 6: Update Org Secrets
            # -----------------------------
            - name: Update Organization Secrets
              run: |
                  update_secret () {
                    curl -s -X PUT \
                      -H "Authorization: Bearer $GH_TOKEN" \
                      -H "Accept: application/vnd.github+json" \
                      https://api.github.com/orgs/${{ github.repository_owner }}/actions/secrets/$1 \
                      -d "{
                        \"encrypted_value\": \"$2\",
                        \"key_id\": \"$KEY_ID\"
                      }"
                  }

                  update_secret ARM_CLIENT_ID "$ENC_CLIENT_ID"
                  update_secret ARM_SUBSCRIPTION_ID "$ENC_SUBSCRIPTION_ID"
                  update_secret ARM_TENANT_ID "$ENC_TENANT_ID"

            - name: Done
              run: echo "âœ… Org secrets updated securely using GitHub App"
